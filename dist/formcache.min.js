/*!
 * formcache v0.0.1
 * https://github.com/fengyuanchen/formcache
 *
 * Copyright 2014 Fengyuan Chen
 * Released under the MIT license
 */

!function(a){"function"==typeof define&&define.amd?define("formcache",["jquery"],a):a(jQuery)}(function(a){"use strict";var b=a(window),c=window.sessionStorage,d=window.localStorage,e="undefined",f=".formcache",g="change"+f,h="beforeunload"+f,i=function(a){return"checkbox"===a.type||"radio"===a.type},j=function(a){return parseInt(a,10)},k=function(b,c){this.form=b,this.$form=a(b),this.defaults=a.extend({},k.DEFAULTS,a.isPlainObject(c)?c:{}),this.init()};k.prototype={constructor:k,init:function(){var b,e=this.$form,f=this.defaults,g=f.key||e.data("key");g||(a("form").each(function(b){a(this).data("key",b)}),g=e.data("key")),this.key=g=location.pathname+"#formcache-"+g,c&&(b=c.getItem(g)),!b&&d&&(b=d.getItem(g)),this.caches="string"==typeof b?JSON.parse(b):[],this.index=0,this.activeIndex=0,this.storing=null,a.isArray(f.controls)||(f.controls=[]),this.$controls=e.find(f.controls.join()),this.addListeners(),this.outputCache()},addListeners:function(){this.$controls.on(g,this._change=a.proxy(this.change,this)),b.on(h,this._beforeunload=a.proxy(this.beforeunload,this))},removeListeners:function(){this.$controls.off(g,this._change),b.off(h,this._beforeunload)},change:function(b){var c,d,e=b.target,f=a(e),g=f.attr("name"),h=[];g&&(c=g.replace(/[\.\*\+\^\$\:\!\[\]#>~]+/g,""),this.$controls.filter("[name*='"+c+"']").each(function(){i(e)?h.push(this.checked):(d=a(this).val(),d&&h.push(d))}),h.length&&(this.update(g,h),clearTimeout(this.storing),this.storing=setTimeout(a.proxy(this.store,this),1e3)))},beforeunload:function(){this.update(),this.store()},update:function(a,b){var c=this.activeIndex||this.index,d=this.getCache(c);"string"==typeof a?d[a]=b:d=this.serialize(),this.setCache(c,d)},serialize:function(){var b={};return this.$controls.each(function(){var c,d,e=a(this),f=e.attr("name");f&&(c=b[f],c=a.isArray(c)?c:[],i(this)?c.push(this.checked):(d=e.val(),d&&c.push(d)),c.length&&(b[f]=c))}),b},getCache:function(a){return this.caches[j(a)||this.index]||{}},getCaches:function(){return this.caches},setCache:function(b,c){typeof c===e&&(c=b,b=0/0),a.isPlainObject(c)&&(b=j(b)||this.index,this.caches[b]=c,this.store())},setCaches:function(b){a.isArray(b)&&(this.caches=b,this.store())},removeCache:function(a){this.caches.splice(j(a)||this.index,1),this.store()},removeCaches:function(){this.caches=[],this.store()},outputCache:function(b){var c=this.getCache(b);a.isPlainObject(c)&&(this.activeIndex=j(b)||this.index,c=a.extend(!0,{},c),this.$controls.each(function(){var b,d,e=a(this),f=e.attr("name");f&&(b=c[f],a.isArray(b)&&b.length&&(d=b.shift(),i(this)?this.checked=d:e.val(d)))}))},store:function(){var b=this.caches,e=this.key,f=this.defaults;a.isArray(b)&&(b=JSON.stringify(b),f.session&&c&&c.setItem(e,b),f.local&&d&&d.setItem(e,b))},clear:function(){var a=this.key,b=this.defaults;b.session&&c&&c.removeItem(a),b.local&&d&&d.removeItem(a)},destroy:function(){this.removeListeners(),this.$form.removeData("formcache")}},k.DEFAULTS={key:"",local:!0,session:!0,controls:["select","textarea","input"]},k.setDefaults=function(b){a.extend(k.DEFAULTS,b)},k.other=a.fn.formcache,a.fn.formcache=function(b){var c,d=[].slice.call(arguments,1);return this.each(function(){var e,f=a(this),g=f.data("formcache");g||f.data("formcache",g=new k(this,b)),"string"==typeof b&&a.isFunction(e=g[b])&&(c=e.apply(g,d))}),typeof c!==e?c:this},a.fn.formcache.Constructor=k,a.fn.formcache.setDefaults=k.setDefaults,a.fn.formcache.noConflict=function(){return a.fn.formcache=k.other,this},a(function(){a("form[data-toggle='formcache']").formcache()})});